<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SecretSanta</title>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="smartwizard/dist/css/smart_wizard.min.css" rel="stylesheet" type="text/css" />
    <link href="smartwizard/dist/css/smart_wizard_theme_arrows.min.css" rel="stylesheet" type="text/css" />
    <link href="medium/css/medium-editor.min.css" rel="stylesheet" type="text/css" />
    <link href="medium/css/themes/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .error {
            color:red;
        }
    </style>
</head>
<body>
<form action="#" id="mailconfigForm" role="form" data-toggle="validator" method="post" accept-charset="utf-8">
    <div id="smartwizard">
        <ul>
            <li><a href="#step-1">E-Mail<br /><small>Account data</small></a></li>
            <li><a href="#step-2">E-Mail<br /><small>Set the subject</small></a></li>
            <li><a href="#step-3">Participants<br /><small>Include yourself!</small></a></li>
            <li><a href="#step-4">Template<br /><small>Edit the e-mail content</small></a></li>
        </ul>
        <div>
            <div id="step-1" class="">
                <div id="form-step-0" role="form" data-toggle="validator">
                    <h2>Deine SMTP Daten</h2>
                    <div class="form-group">
                        <p>
                            <label for="SmtpUser">Username:</label>
                            <input type="text" class="form-control" name="SmtpUser" id="smtpusername"
                                   placeholder="SMTP username" required>
                        </p>
                        <p>
                            <label for="SmtpPass">Password:</label>
                            <input type="password" class="form-control" name="SmtpPass" id="smtppassword" required>
                        </p>
                        <p>
                            <label for="SmtpFrom">From Address:</label>
                            <input type="email" class="form-control" name="SmtpFrom" id="smtpfrom" required>
                        </p>
                        <p>
                            <label for="SmtpServer">Server name:</label>
                            <input type="text" class="form-control" name="SmtpServer" id="smtpserver"
                                   value="smtp.gmail.com" required>
                        </p>
                        <p>
                            <label for="SmtpPort">Server port:</label>
                            <input type="number" class="form-control" name="SmtpPort" id="smtpport" value="587"
                                   required>
                        </p>
                    </div>
                </div>
            </div>
            <div id="step-2" class="">
                <div class="form-group">
                    <p>
                        <label for="Subject">E-Mail subject:</label>
                        <input type="text" class="form-control" name="Subject" id="subject" placeholder="The subject of the e-mails. %s will be replaced by the recepient name"
                               required>
                    </p>
                </div>
            </div>
            <div id="step-3" class="">
                <div class="container">
                    <div class="row clearfix">
                        <div class="col-md-12 column">
                            <p>
                                <label for="SmtpPort">Seed (use an old one to get the same random pairing again):</label>
                                <input type="number" class="form-control" name="Seed" id="seed" placeholder="optional">
                            </p>
                            <table class="table table-bordered table-hover" id="participants">
                                <thead>
                                <tr>
                                    <th class="text-center">
                                        #
                                    </th>
                                    <th class="text-center">
                                        Name
                                    </th>
                                    <th class="text-center">
                                        E-Mail
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr id='participant0'>
                                    <td>
                                        1
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[0].Name' placeholder='Name'
                                               class="form-control input-md" required/>
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[0].Email' placeholder='E-Mail'
                                               class="form-control input-md" required/>
                                    </td>
                                </tr>
                                <tr id='participant1'>
                                    <td>
                                        2
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[1].Name' placeholder='Name'
                                               class="form-control input-md" required/>
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[1].Email' placeholder='E-Mail'
                                               class="form-control input-md" required/>
                                    </td>
                                </tr>
                                <tr id='participant2'>
                                    <td>
                                        3
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[2].Name' placeholder='Name'
                                               class="form-control input-md" required/>
                                    </td>
                                    <td>
                                        <input type="text" name='Participants[2].Email' placeholder='E-Mail'
                                               class="form-control input-md" required/>
                                    </td>
                                </tr>
                                <tr id='participant3'></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <a id="add_row" class="btn btn-default pull-left">Add Row</a>
                    <a id='delete_row' class="pull-right btn btn-default">Delete Row</a>
                </div>
            </div>
            <div id="step-4" class="">
                <div class="form-group">
                    <h2>You can edit the E-Mail sent to the participants here:</h2>
                    <div class="editable" style="border: 1px solid darkslategray; border-radius: 5px; padding: 10px; margin: 10px;">
                        <h1>Hello {{.Santa}}!</h1>
                        <h2>You are {{.Presentee}}'s santa!</h2>
                        <p>And remember, do not spend more than <b>$15</b>. ;-)</p>
                    </div>
                    <p>Please make sure to include <code>{{.Santa}}</code> and <code>{{.Presentee}}</code>, these are neccessary placeholders.</p>
                    <p><input type="checkbox" id="toggleMdSource"> Toggle source</p>
                    <textarea name="MailContent" rows="10" class="markdown form-control hidden"></textarea>
                </div>
            </div>
        </div>
    </div>
</form>
    <script src="jquery/jquery-3.2.1.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="jquery/jquery.validate.min.js"></script>
    <script src="jquery/localization/messages_de.min.js"></script>
    <script type="text/javascript" src="smartwizard/dist/js/jquery.smartWizard.min.js"></script>
    <script type="text/javascript" src="medium/js/medium-editor.min.js"></script>
    <script type="text/javascript" src="medium/js/to-markdown.js"></script>
    <script type="text/javascript" src="showdown/showdown.min.js"></script>
    <script type="text/javascript">
        ((function ($) {
            setInterval(function () {
                $.post('/api/heartbeat');
            }, 1000);
            $(document).ready(function () {
                var i=3;
                var sc = new showdown.Converter();
                $("#add_row").click(function(){
                    $('#participant'+i).html("<td>"+ (i+1) +"</td><td><input name='Participants["+i+"].Name' type='text' placeholder='Name' class='form-control input-md'  /></td><td><input  name='Participants["+i+"].Email' type='text' placeholder='E-Mail'  class='form-control input-md'></td></td>");

                    $('#participants').append('<tr id="participant'+(i+1)+'"></tr>');
                    i++;
                });
                $("#delete_row").click(function(){
                    if(i>3){
                        $("#participant"+(i-1)).html('');
                        i--;
                    }
                });
                $sw = $('#smartwizard');
                $("#mailconfigForm").on('submit', function (e) {
                    var url = "/api/sendmail";
                    var data = $("#mailconfigForm").serializeArray();
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: $.param(data), // serializes the form's elements.
                        success: function (data) {
                            console.info(data); //TODO show response on site
                        }
                    });

                    e.preventDefault();
                });
                var btnFinish = $('<button></button>').text('Finish')
                        .addClass('btn btn-info btn-finish')
                        // .attr("disabled", "disabled") TODO enable before commit
                        .on('click', function () {
                            if (!$(this)[0].hasAttribute('disabled')) {
                                var elmForm = $("#mailconfigForm");
                                elmForm.submit();
                                // if (elmForm) {
                                //     elmForm.validate();
                                //     if (!elmForm.valid()) {
                                //         alert('Oops we still have error in the form');
                                //         return false;
                                //     } else {
                                //         elmForm.submit();
                                //         return false;
                                //     }
                                // } TODO enable before commit
                            }
                        });
                var btnCancel = $('<button></button>').text('Cancel')
                        .addClass('btn btn-danger')
                        .on('click', function () {
                            $('#smartwizard').smartWizard("reset");
                            $('#mailconfigForm').find("input, textarea").val("");
                        });
                $sw.smartWizard({
                    theme: 'arrows',
                    keyNavigation: false,
                    transitionEffect: 'fade',
                    lang: {  // Language variables
                        next: '>>',
                        previous: '<<'
                    },
                    toolbarSettings: {
                        toolbarPosition: 'top', // none, top, bottom, both
                        toolbarButtonPosition: 'right', // left, right
                        toolbarExtraButtons: [btnFinish, btnCancel]
                    }
                });
                // $sw.on("leaveStep", function (e, anchorObject, stepNumber, stepDirection) {
                //     var elmForm = $("#mailconfigForm");
                //     // stepDirection === 'forward' :- this condition allows to do the form validation
                //     // only on forward navigation, that makes easy navigation on backwards still do the validation when going next
                //     if (stepDirection === 'forward' && elmForm) {
                //         elmForm.validate();
                //         if (!elmForm.valid()) {
                //             return false;
                //         }
                //     }
                //     return true;
                // }); TODO enable before commit

                $sw.on("showStep", function(e, anchorObject, stepNumber, stepDirection) {
                    // Enable finish button only on last step
                    if (stepNumber < 3) {
                        $('.btn-finish').attr('disabled', 'disabled');
                    } else {
                        $('.btn-finish').removeAttr('disabled');
                    }
                });
                var $md = $('.markdown').first();
                var $editable = $(".editable").first();
                var med = new MediumEditor(".editable", {
                    toolbar: {
                        buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', "unorderedlist"]
                    }
                });
                $md.val(toMarkdown($editable.html()));
                med.subscribe('editableInput', function(event, editable) {
                    if(!$editable.is(':focus')){
                        return;
                    }
                    $md.val(toMarkdown($editable.html()));
                });
                $(document).on('input propertychange', "textarea[name='MailContent']", function () {
                    if(!$md.is(':focus')){
                        return;
                    }
                    med.setContent(sc.makeHtml($md.val()), 0);
                });
                $('#toggleMdSource').on('click', function () {
                    if($md.hasClass('hidden')) {
                        $md.removeClass('hidden');
                    }else{
                        $md.addClass('hidden');
                    }
                })
            });
        }))(jQuery);
        </script>
</body>
</html>